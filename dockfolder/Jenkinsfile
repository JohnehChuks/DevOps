pipeline {
    agent any

    stages {

        /* 
        NOTE: This stage is NOT needed in normal declarative pipelines.
        Jenkins automatically checks out the GitHub repository BEFORE executing this Jenkinsfile.

        If we clone the repository again inside the pipeline, it conflicts with the automatic
        SCM checkout and causes the error:

            "Couldn't find any revision to build"

        WHY YOU DON'T NEED THIS STAGE:
        - Jenkins already clones the repo specified in the job configuration.
        - The Jenkinsfile is loaded *from that same checkout*.
        - Doing another git pull in the same workspace overwrites Jenkins-internal metadata.
        - This breaks the build.

        HOWEVER, IF YOU MUST USE A GIT CHECKOUT INSIDE THE PIPELINE, HERE ARE SAFE METHODS:

        1. **Use a different folder**
           Clone into a separate directory so it does not conflict:
               sh 'git clone https://github.com/JohnehChuks/DevOps.git another-folder'

        2. **Disable Jenkins automatic checkout**
           At the top of the Jenkinsfile:
               options { skipDefaultCheckout(true) }
           Then manually add your clone stage:
               stage('Clone') {
                   steps {
                       git url: 'https://github.com/JohnehChuks/DevOps.git', credentialsId: 'github-pat'
                   }
               }

        3. **Use a Multibranch Pipeline**
           Multibranch pipelines manage SCM automatically.
           If you want manual control, you can:
               - Disable "Discover branches" rules
               - Use `checkout scm` inside a stage

        So the clone stage below is commented out because Jenkins already performs the clone.
        Leave it commented to avoid breaking the pipeline.

        stage('Clone Repository') {
            steps {
                git url: 'https://github.com/JohnehChuks/DevOps.git', credentialsId: 'github-pat'
            }
        }

        4**  makesure you add docker to jenkins group:
         sudo usermod -aG docker jenkins
         sudo systemctl restart jenkins
         use this to confirm: groups jenkins
        */

        stage('Build Docker Image') {
            steps {
                sh 'cd dockfolder && docker build -t mydockerimagename .'
            }
        }

        stage('Run Container') {
            steps {
                sh 'docker stop DockContainer || true'
                sh 'docker rm DockContainer || true'
                sh 'docker run -d --name DockContainer -p 8050:80 mydockerimagename'
            }
        }
    }
}
